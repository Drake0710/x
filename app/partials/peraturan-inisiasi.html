<script>
    if(typeof app === 'undefined'){
        document.location.href='index.php';
    }
</script>

<style>
td.details-control {
    background: url('../template/img/details_open.png') no-repeat center center;
    cursor: pointer;
}
tr.shown td.details-control {
    background: url('../template/img/details_close.png') no-repeat center center;
}
.chosen-container-multi .chosen-choices
{
    border-radius: 5px;
    box-shadow: inset 0px 1px 2px rgba(0,0,0,0.3);
    border: none;
    min-height: 38px;
    cursor: text;
    border-bottom: 1px solid #ddd;
    width: 100%;
    text-indent: 0;
	line-height: 1.25;
	padding: .5rem .75rem;
    font-size: 1rem;
}
</style>

<!-- Bread crumb and right sidebar toggle -->
<div class="row page-titles m-b-0">
	 <div class="col-md-5 col-8 align-self-center">
		<h3 class="text-themecolor m-b-0 m-t-0">Rekam Inisiasi</h3>
		<ol class="breadcrumb">
			<li class="breadcrumb-item"><a href="javascript:void(0)">Peraturan</a></li>
			<li class="breadcrumb-item active">Rekam Inisiasi</li>
		</ol>
	</div>
</div>
<!-- ============================================================== -->
<!-- End Bread crumb and right sidebar toggle -->
<!-- ============================================================== -->
<!-- ============================================================== -->
<!-- Start Page Content -->
<!-- ============================================================== -->
<div class="row">
	<!-- Column -->
	<div class="col-12">
		<div class="card card-outline-primary" id="div-tabel">
			<div class="card-header">
				<h4 class="m-b-0 text-white"><i class="mdi mdi-note-plus-outline"></i> Rekam Inisiasi</h4>
			</div>
			<div class="card-body table-responsive">
				<!-- <div class="table-responsive m-t-40"> -->
					<table id="tabel-ruh" class="table table-bordered table-striped">
						<thead>
							<tr>
								<th></th>
								<th>No</th>
								<th>Nama Inisiator</th>
								<th>Asal Unit</th>
								<th>Alur Peraturan</th>
								<th>Keterangan</th>
								<th>Aksi</th>
							</tr>
						</thead>
						<tbody>
						</tbody>
					</table>
				<!-- </div> -->
			</div>
		</div>
		<div class="card card-outline-primary" id="div-form">
			<div class="card-header">
				<h4 class="m-b-0 text-white"><i class="mdi mdi-file-pdf"></i> Rekam/Ubah Data Inisiasi</h4>
			</div>
			<div class="card-body">
				<form id="form-ruh" name="form-ruh" class="form-horizontal">
					<input type="text" id="inp-id" name="inp-id" class="hide">
					<input type="text" id="inp-rekambaru" name="inp-rekambaru" class="hide">
					<input type="hidden" id="_token" name="_token" />
					<div class="form-group  m-t-40 row">
						<label class="col-form-label col-lg-3">Alur Peraturan</label>
						<div class="col-lg-7">
							<select class="form-control chosen" id="alur_peraturan" name="alur_peraturan">
								<option value="" style="display:none;">Pilih Alur</option>
							</select>
						</div>
						<div class="col-lg-2">
							<span id="warning-alur_peraturan" class="label label-warning warning">Required!</span>
						</div>
					</div>
					<div class="form-group row">
						<label class="col-form-label col-lg-3">Keterangan</label>
						<div class="col-lg-7">
							<textarea id="keterangan" name="keterangan" class="form-control" rows="5" value="<?php echo $nama; ?>"></textarea>
						</div>
						<div class="col-lg-2">
							<span id="warning-keterangan" class="label label-warning warning">Required!</span>
						</div>
					</div>
					<div class="form-group row">
						<label class="col-form-label col-lg-3">Upload File Draft</label>
						<div class="col-lg-7">
							<input type="file" id="file_draft" name="file_draft" class="form-control" value="<?php echo $id; ?>"></input>
						</div>
						<div class="col-lg-2">
							<span id="warning-file_draft" class="label label-warning warning">Required!</span>
						</div>
					</div>
					<div class="form-group row">
						<label class="col-form-label col-lg-3">Nomor ND</label>
						<div class="col-lg-7">
							<input id="no_nd" name="no_nd" class="form-control" value="<?php echo $nama; ?>"></input>
						</div>
						<div class="col-lg-2">
							<span id="warning-no_nd" class="label label-warning warning">Required!</span>
						</div>
					</div>
					<div class="form-group row">
						<label class="col-form-label col-lg-3">Tanggal ND</label>
						<div class="input-group col-lg-4">
							<input type="text" class="form-control mydatepicker" id="tgl_nd" name="tgl_nd" placeholder="mm/dd/yyyy">
							<span class="input-group-addon"><i class="icon-calender"></i></span> 
						</div>
						<div class="col-lg-2">
							<span id="warning-tgl_nd" class="label label-warning warning">Required!</span>
						</div>
					</div>
					<div class="form-group row">
						<label class="col-form-label col-lg-3">Upload File ND</label>
						<div class="col-lg-7">
							<input type="file" id="file_nd" name="file_nd" class="form-control" value="<?php echo $id; ?>"></input>
						</div>
						<div class="col-lg-2">
							<span id="warning-file_nd" class="label label-warning warning">Required!</span>
						</div>
					</div>
					<div class="form-group row">
						<label class="col-form-label col-lg-3">Nomor Net</label>
						<div class="col-lg-7">
							<input id="no_net" name="no_net" class="form-control" value="<?php echo $nama; ?>"></input>
						</div>
						<div class="col-lg-2">
							<span id="warning-no_net" class="label label-warning warning">Required!</span>
						</div>
					</div>
					<div class="form-group row">
						<label class="col-form-label col-lg-3">Tanggal Net</label>
						<div class="input-group col-lg-4">
							<input type="text" class="form-control mydatepicker" id="tgl_net" name="tgl_net" placeholder="mm/dd/yyyy">
							<span class="input-group-addon"><i class="icon-calender"></i></span> 
						</div>
						<div class="col-lg-2">
							<span id="warning-tgl_net" class="label label-warning warning">Required!</span>
						</div>
					</div>
					<div class="form-group row">
						<label class="col-form-label col-lg-3">Upload File ND</label>
						<div class="col-lg-7">
							<input type="file" id="file_net" name="file_net" class="form-control" value="<?php echo $id; ?>"></input>
						</div>
						<div class="col-lg-2">
							<span id="warning-file_net" class="label label-warning warning">Required!</span>
						</div>
					</div>
					</br>
					<div class="form-group row">
						<label class="control-label col-lg-3"></label>
						<div class="col-lg-5">
							<button id="simpan" type="submit" class="btn btn-primary waves-effect waves-light m-r-10">Simpan</button>
							<button id="batal" type="submit" class="btn btn-inverse waves-effect waves-light">Batal</button>
						</div>
					</div>
				</form>
			</div>
		</div>
	</div>
	<!-- Column -->
</div>
<!-- Row -->
<!-- ============================================================== -->
<!-- End PAge Content -->
<!-- ============================================================== -->

<script>
    $(document).ready(function() {
		
		jQuery.fn.dataTable.ext.errMode = 'none';
		
		jQuery('.chosen').chosen();
		
		// Date Picker
		//jQuery('.mydatepicker, #datepicker').datepicker();
		jQuery('.mydatepicker').datepicker({
			autoclose: true,
			todayHighlight: true
		});
		
		/*jQuery.get('dropdown/alur-peraturan', function(result){
			jQuery('#alur_peraturan').html(result).trigger('chosen:updated');
		});
		
		function format ( d ) {
			// `d` is the original data object for the row
			return '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">'+
				'<tr>'+
					'<td>Jenis Peraturan:</td>'+
					'<td>'+d[7]+'</td>'+
				'</tr>'+
				'<tr>'+
					'<td>Sifat Peraturan:</td>'+
					'<td>'+d[8]+'</td>'+
				'</tr>'+
				'<tr>'+
					'<td>Tentang:</td>'+
					'<td>'+d[9]+'</td>'+
				'</tr>'+
				'<tr>'+
					'<td>Abstrak:</td>'+
					'<td>'+d[10]+'</td>'+
				'</tr>'+
			'</table>';
		}
		
		function cari_data(id){
			jQuery.getJSON('mon/peraturan/'+id, function(result){
				if(result){
					jQuery('#inp-id').val(result.id);
					jQuery('#inp-rekambaru').val('0');
					jQuery('#id').val(result.id);
					jQuery('#no_peraturan').val(result.no_peraturan);
					jQuery('#tahun_peraturan').val(result.tahun_peraturan);
					jQuery('#jenis_peraturan').val(result.id_jenis_peraturan).trigger('chosen:updated');
					jQuery('#sifat_peraturan').val(result.id_sifat_peraturan).trigger('chosen:updated');
					jQuery('#tentang').val(result.tentang);
					jQuery('#abstrak').val(result.abstrak);
					jQuery('#status').val(result.is_aktif);
					if(result.is_aktif=='1'){
						jQuery('#status').prop('checked',true);
					} else {
						jQuery('#status').prop('checked',false);
					}
					jQuery('#publish').val(result.is_publish);
					if(result.is_publish=='1'){
						jQuery('#publish').prop('checked',true);
					} else {
						jQuery('#publish').prop('checked',false);
					}
					jQuery('#div-tabel').hide();
					jQuery('#div-form').show();
				}
			});
		}
		
		function form_valid(str_id){
			var arr_id=str_id.split(',');
			var lanjut=true;
			for(x=0;x<arr_id.length;x++){
				if(jQuery('#'+arr_id[x]).val()==''){
					jQuery('#warning-'+arr_id[x]).show();
					lanjut=false;
				}
			}
			return lanjut;
		}
		
		var table = jQuery('#tabel-ruh').DataTable({
			//bFilter: false,
			//bProcessing:true,
			oLanguage:{
				"sProcessing":   "Sedang proses...",
				"sLengthMenu":   "Tampilan _MENU_ entri",
				"sZeroRecords":  "Tidak ditemukan data yang sesuai",
				"sInfo":         "Tampilan _START_ sampai _END_ dari _TOTAL_ entri",
				"sInfoEmpty":    "Tampilan 0 hingga 0 dari 0 entri",
				"sInfoFiltered": "(disaring dari _MAX_ entri keseluruhan)",
				"sInfoPostFix":  "",
				"sSearch":       "Cari:",
				"sUrl":          "",
				"oPaginate": {
				  "sFirst":    "Awal",
				  "sPrevious": "Sebelum",
				  "sNext":     "Sesudah",
				  "sLast":     "Akhir"
				}
			},
			"columns": [
				{
					"className":      'details-control',
					"orderable":      false,
					"data":           null,
					"defaultContent": ''
				},
				{},
				{},
				{},
				{},
				{},
				{}
			],
			aaSorting: [],
			bServerSide: true,
			sAjaxSource: "mon/peraturan"
		});
		
		// Add event listener for opening and closing details
		$('#tabel-ruh').on('click', 'td.details-control', function () {
			var tr = $(this).closest('tr');
			var row = table.row( tr );
	 
			if ( row.child.isShown() ) {
				// This row is already open - close it
				row.child.hide();
				tr.removeClass('shown');
			}
			else {
				// Open this row
				row.child( format(row.data()) ).show();
				tr.addClass('shown');
			}
		} );
		
		function form_default(){
			jQuery('input,textarea').val('');
			jQuery('.chosen').val('').trigger('chosen:updated');
			jQuery('#div-form').hide();
			jQuery('#div-tabel').show();
			//jQuery('#div-kppn,#div-kanwil').hide();
			jQuery('.warning').hide();
		}
		
		form_default();
		
		$("input[type='checkbox']").change(function(){
			if($(this).prop("checked") == true){
			   //run code
			   jQuery($(this).val('1'));
			}else{
			   //run code
			   jQuery($(this).val('0'));
			}
		});
		
		jQuery('#batal').click(function(){
			form_default();
		});
		
		jQuery('body').off('click', '.ubah-data').on('click', '.ubah-data', function(){
			var id=this.id;
			cari_data(id);
		});
		
		jQuery('#simpan').click(function(){
			jQuery('#simpan').html('<span class="">Loading.....</span>');
			jQuery('#simpan').prop('disabled', true);
			
			var lanjut = form_valid('id,no_peraturan,tahun_peraturan,tentang,abstrak,jenis_peraturan,sifat_peraturan,status,publish');
			
			if(lanjut){
			
				jQuery.get('token', function(token){
					if(token){
						jQuery('#_token').val(token);
						var data = jQuery('#form-ruh').serialize();
						jQuery.ajax({
							url:'mon/peraturan',
							method:'PUT',
							data:data,
							success:function(result){
								if(result=='success'){
									jQuery('#simpan').html('<span class=""><i class="fa fa-save"></i> Simpan</span>');
									jQuery('#simpan').prop('disabled',false);
									alertify.log('Proses simpan berhasil!');
									form_default();
									table.ajax.reload();
								}
								else{
									alertify.log(result);
									jQuery('#simpan').html('<span class=""><i class="fa fa-save"></i> Simpan</span>');
									jQuery('#simpan').prop('disabled', false);
								}
							},
							error:function(result){
								alertify.log('Koneksi terputus!');
								jQuery('#simpan').html('<span class=""><i class="fa fa-save"></i> Simpan</span>');
								jQuery('#simpan').prop('disabled', false);
							}
						});
						
					}
					else{
						jQuery('#simpan').html('Simpan');
						jQuery('#simpan').prop('disabled',false);
						alertify.log('Proses ubah gagal. Silahkan refresh halaman browser anda.');
					}
				});
				
			}
			else{
				alertify.log('Kolom tidak dapat dikosongkan!');
				jQuery('#simpan').html('<span class=""><i class="fa fa-save"></i> Simpan</span>');
				jQuery('#simpan').prop('disabled', false);
			}
		});*/
		
    });
</script>